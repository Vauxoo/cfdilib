<PLZ:Polizas
    xmlns:PLZ="http://www.sat.gob.mx/esquemas/ContabilidadE/1_3/PolizasPeriodo"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.sat.gob.mx/esquemas/ContabilidadE/1_3/PolizasPeriodo http://www.sat.gob.mx/esquemas/ContabilidadE/1_3/PolizasPeriodo/PolizasPeriodo_1_3.xsd"
    Anio="{{ inv.year }}"
    Mes="{{ inv.month }}"
    RFC="{{ inv.vat }}"
    TipoSolicitud="{{ inv.type }}"
    Version="1.3"
    {% if inv.certificate_id %}
    Sello=""
    noCertificado="{{ inv.certificate_id.serial_number   }}"
    Certificado="{{ inv.certificate_id.content_pem   }}"
    {% endif %}>

{% for move in inv.moves %}
    <PLZ:Poliza Concepto="{{ move.name|truncate(300, True) }}" Fecha="{{ move.date }}" NumUnIdenPol="{{ move.id }}">
    {% for line in move.line_ids %}
        <PLZ:Transaccion Concepto="{{ line.name|truncate(200, True) }}" DesCta="{{ line.account_id.name|truncate(100, True) }}"
                         NumCta="{{ line.account_id.code }}" Debe="{{ '%.2f' % line.debit|float }}" Haber="{{ '%.2f' % line.credit|float }}">
            {% if (line.invoice_id and line.invoice_id.cfdi_uuid) or (line.payment_id and line.payment_id.l10n_mx_edi_cfdi_uuid) %}
                <PLZ:CompNal
                    UUID_CFDI="{{ (line.invoice_id and line.invoice_id.cfdi_uuid) or (line.payment_id and line.payment_id.l10n_mx_edi_cfdi_uuid) }}"
                    RFC="{{ (line.invoice_id and line.invoice_id.partner_id.vat) or (line.payment_id and line.payment_id.partner_id.vat) }}"
                    MontoTotal="{{ (line.invoice_id and '%.2f' % line.invoice_id.amount_total|float) or (line.payment_id and '%.2f' % line.payment_id.amount|float) }}"
                    {% if (line.invoice_id and line.invoice_id.currency_id.name != 'MXN') or (line.payment_id and line.payment_id.currency_id.name != 'MXN') %}
                        Moneda="{{ (line.invoice_id and line.invoice_id.currency_id.name) or (line.payment_id and line.payment_id.currency_id.name) }}"
                        TipCamb="{{ (line.invoice_id and '%.5f' % line.invoice_id.rate|float) or (line.payment_id and '%.5f' % line.payment_id.get_payment_cfdi_v33().get('rate', 0)|float) }}"
                    {% endif %}/>
            {% endif %}
            {% if not line.invoice_id and not line.payment_id %}
                {% for session in inv.pos_sessions if session.name == line.ref and session.check_session_cfdi(with_partner=(True if line.partner_id else False), doc_type=('E' if line.quantity < 0 or (line.full_reconcile_id and line.credit > line.debit) else 'I')) %}
                    {% set cfdi_values = session.check_session_cfdi(with_partner=(True if line.partner_id else False), doc_type=('E' if line.quantity < 0 or (line.full_reconcile_id and line.credit > line.debit) else 'I')) %}
                    <PLZ:CompNal
                        UUID_CFDI="{{ cfdi_values.get('uuid') }}"
                        RFC="{{ cfdi_values.get('rfc') }}"
                        MontoTotal="{{ cfdi_values.get('total') }}"
                        {% if cfdi_values.get('currency') != 'MXN' %}
                            Moneda="{{ cfdi_values.get('currency') }}"
                            TipCamb="{{ '%.5f' % cfdi_values.get('rate')|float }}"
                        {% endif %}/>
                {% endfor %}
            {% endif %}
        </PLZ:Transaccion>
    {% endfor %}
    </PLZ:Poliza>
{% endfor %}
</PLZ:Polizas>
